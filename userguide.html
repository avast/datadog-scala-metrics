<!DOCTYPE html><html><head><title>datadog4s: User guide</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tomas Herman" /><meta name="description" content="Great monitoring made easy" /><meta name="og:image" content="/datadog4s/img/poster.png" /><meta name="image" property="og:image" content="/datadog4s/img/poster.png" /><meta name="og:title" content="datadog4s: User guide" /><meta name="title" property="og:title" content="datadog4s: User guide" /><meta name="og:site_name" content="datadog4s" /><meta name="og:url" content="https://github.com/datadoh4s/datadog4s" /><meta name="og:type" content="website" /><meta name="og:description" content="Great monitoring made easy" /><link rel="icon" type="image/png" href="/datadog4s/img/favicon.png" /><meta name="twitter:title" content="datadog4s: User guide" /><meta name="twitter:image" content="https://datadog4s.github.io/datadog4s/img/poster.png" /><meta name="twitter:description" content="Great monitoring made easy" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/datadog4s/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/datadog4s/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/datadog4s/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/datadog4s/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/datadog4s/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/datadog4s/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/datadog4s/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/datadog4s/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/datadog4s/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/datadog4s/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/datadog4s/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/datadog4s/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/datadog4s/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/datadog4s/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/datadog4s/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/datadog4s/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/datadog4s/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/datadog4s/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/datadog4s/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/datadog4s/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/datadog4s/highlight/styles/vs.css" /><link rel="stylesheet" href="/datadog4s/css/pattern-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/datadog4s/" class="brand"><div class="brand-wrapper"><span>datadog4s</span></div></a></li> <li><a href="/datadog4s/install.html" class="">Install</a></li> <li><a href="/datadog4s/userguide.html" class=" active ">User guide</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav hidden-xs hidden-sm"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/datadog4s/datadog4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/datadog4s/datadog4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('datadog4s Great monitoring made easy');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('datadog4s Great monitoring made easy');"><i class="fa fa-facebook"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="datadog4s" data-github-repo="datadog4s"><div class="content-wrapper"><section><h1 id="user-guide">User guide</h1>

<ul>
  <li><a href="#creating-metric-factory">Creating metric factory</a></li>
  <li><a href="#creating-metrics">Creating metrics</a></li>
  <li><a href="#timers">Timers</a></li>
  <li><a href="#tagging">Tagging</a>
    <ul>
      <li><a href="#tagger">Tagger</a></li>
    </ul>
  </li>
  <li><a href="#extensions">Extensions</a>
    <ul>
      <li><a href="#http4s">Http4s</a></li>
      <li><a href="#jvm-monitoring">Jvm monitoring</a></li>
    </ul>
  </li>
</ul>

<h2 id="creating-metric-factory">Creating metric factory</h2>

<p>To start creating your metrics, first you need to create a <code class="language-plaintext highlighter-rouge">MetricFactory[F[_]]</code>. Currently, the only implementation is
in <code class="language-plaintext highlighter-rouge">statsd</code> package. MetricFactory is purely functional, so it requires you to provide type constructor which
implements <code class="language-plaintext highlighter-rouge">cats.effect.Sync</code>. For the simplicity, we will use <code class="language-plaintext highlighter-rouge">cats.effect.IO</code> in these examples.</p>

<p>To create an instance, we need to provide it with configuration which contains a few basic fields, like address of the
StatsD server, prefix etc. For more information see scaladoc of the config class.</p>

<p>The instance is wrapped in <code class="language-plaintext highlighter-rouge">Resource</code> because of the underlying <code class="language-plaintext highlighter-rouge">StatsD</code> client.</p>

<p>```scala mdoc:silent
import java.net.InetSocketAddress
import cats.effect.*
import com.avast.datadog4s.api.*
import com.avast.datadog4s.api.metric.*
import com.avast.datadog4s.*</p>

<p>val statsDServer = InetSocketAddress.createUnresolved(“localhost”, 8125)
val config = StatsDMetricFactoryConfig(Some(“my-app-name”), statsDServer)</p>

<p>val factoryResource: Resource[IO, MetricFactory[IO]] = StatsDMetricFactory.make(config)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Creating metrics

Once you have a metrics factory, creating metrics is straight-forward. Note that all metric operations return
side-effecting actions.

```scala mdoc:silent
factoryResource.use { factory =&gt;
    val count: Count[IO] = factory.count("hits")
    val histogram: Histogram[IO, Long] = factory.histogram.long("my-histogram")
    for {
        _ &lt;-  count.inc() // increase count by one
        _ &lt;- histogram.record(1337, Tag.of("username", "xyz")) // record a value to histogram with Tag
    } yield {
        ()
    }
}
</code></pre></div></div>

<h2 id="timers">Timers</h2>

<p>In addition to basic datadog metrics, we provide a <code class="language-plaintext highlighter-rouge">Timer[F]</code> abstraction which has proved to be very useful is
practice. Timers provide you with <code class="language-plaintext highlighter-rouge">.time[A](fa: F[A]): F[A]</code> method, which will measure how long it took to run
provided <code class="language-plaintext highlighter-rouge">fa</code>. In addition, it tags the metric with <code class="language-plaintext highlighter-rouge">success:true</code> or <code class="language-plaintext highlighter-rouge">success:false</code>
and <code class="language-plaintext highlighter-rouge">exception:&lt;&lt;throwable class name&gt;&gt;</code> in case the <code class="language-plaintext highlighter-rouge">fa</code> failed.</p>

<p>In addition to <code class="language-plaintext highlighter-rouge">.time[A]</code> method it also allows for recording of raw values that represent elapsed time or even raw time
data. You can see example of such calls below.</p>

<p>Optionally, when creating a <code class="language-plaintext highlighter-rouge">Timer</code>, you can also set the time units which will be used for reporting. By default, all
timers create with <code class="language-plaintext highlighter-rouge">microsecond</code> granularity. You can provide your own time unit if you need more or less precision.</p>

<h3 id="histogram-vs-distribution">Histogram vs Distribution</h3>

<p>There are two versions of timers, one backed by <code class="language-plaintext highlighter-rouge">Histogram</code> and one backed by <code class="language-plaintext highlighter-rouge">Distribution</code>. You can read scaladoc for
more details and links to datadog documentation.</p>

<p>Long story short, <code class="language-plaintext highlighter-rouge">histogram</code> backed timers are aggregated per datadog agent, while the <code class="language-plaintext highlighter-rouge">distributions</code> are computed on
datadog server. The implications are that <code class="language-plaintext highlighter-rouge">distribution</code> based timers, and it’s buckets (50th, 75th, 95th percentile
etc) are more correct and in general it’s the implementation that we’d suggest to use.</p>

<h3 id="example">Example</h3>

<p>```scala mdoc:silent
import java.util.concurrent.TimeUnit</p>

<p>factoryResource.use { factory =&gt;
    val timer = factory.timer.distribution(“request-latency”)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timer.time(IO.delay(println("success"))) // tagged with success:true
timer.time(IO.raiseError(new NullPointerException("error"))) // tagged with success:false and exception:NullPointerException

val nanoTimer = factory.timer.distribution("nano-timer", timeUnit = TimeUnit.NANOSECONDS)
nanoTimer.time(IO.delay(println("success"))) // metric will be recorded with 'nanoseconds' precision

// timer.record works for all types that implement `ElapsedTime` typeclass, out of the box we provide implementation
// for java.time.Duration and scala.concurrent.duration.FiniteDuration

import java.time.Duration
timer.record(Duration.ofNanos(1000))

import scala.concurrent.duration.FiniteDuration
timer.record(FiniteDuration(1000, TimeUnit.MILLISECONDS))

timer.recordTime(1000L, TimeUnit.MILLISECONDS) } ```
</code></pre></div></div>

<h2 id="tagging">Tagging</h2>

<p>There are two ways to create a <code class="language-plaintext highlighter-rouge">Tag</code> instances. One way is using <code class="language-plaintext highlighter-rouge">of</code> method of <code class="language-plaintext highlighter-rouge">Tag</code> object, like so:</p>

<p>```scala mdoc
import com.avast.datadog4s.api.Tag</p>

<p>Tag.of(“endpoint”, “admin/login”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
This is simple and straight-forward, but in some cases it leaves your code with `Tag` keys scattered around and forces
you to repeat it - making it prone to misspells etc. The better way is to use `Tagger`.

### Tagger

`Tagger[T]` is basically a factory interface for creating tags based on provided value of type `T` - as long as
implicit `TagValue[T]` exists in scope. This instance is used for converting `T` into `String`. By using `Tagger`, you
get a single value that you can use in multiple places in your code to create `Tag`s without repeating yourself.

Example:

```scala mdoc
import com.avast.datadog4s.api.tag.{TagValue, Tagger}

val pathTagger: Tagger[String] = Tagger.make[String]("path")
assert(Tag.of("path", "admin/login") == pathTagger.tag("admin/login"))

// tagger also supports taging using custom types using TagValue typeclass

case class StatusCode(value: Int) 

implicit val statusCodeTagValue: TagValue[StatusCode] = TagValue[Int].contramap[StatusCode](sc =&gt; sc.value)

val statusCodeTagger: Tagger[StatusCode] = Tagger.make[StatusCode]("statusCode")

assert(Tag.of("statusCode", "200") == statusCodeTagger.tag(StatusCode(200)))
</code></pre></div></div>

<h2 id="extensions">Extensions</h2>

<p>Extensions are packages that monitor some functionality for you - without you having to do much.</p>

<h3 id="http4s">Http4s</h3>

<p>Http4s package (<code class="language-plaintext highlighter-rouge">datadog4s-http4s</code>) provides implementation of <a href="metrics-ops">MetricsOps</a> that is used
by <a href="http4s">http4s</a> to report both client and server metrics.</p>

<p>```scala mdoc
import com.avast.datadog4s.extension.http4s.*</p>

<p>factoryResource.use { metricFactory =&gt;
    // create metrics factory and use it as you please
    DatadogMetricsOps.builder<a href="metricFactory">IO</a>.build().flatMap { metricOps =&gt;
      // setup http4s Metrics middleware here
      val _ = metricOps
      IO.unit
    }
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Jvm monitoring

JVM monitoring package (`datadog4s-jvm`) collects a bunch of JVM metrics that we found useful over last 5 or so years
running JVM apps in Avast. Those metrics can be found in [JvmReporter][jvm-reporter-class] and are hopefully
self-explanatory. We tried to match reported metrics to [datadog JVM runtime metrics][ddog-jvm-metrics]

Usage can not be simpler (unless you want to configure things like collection-frequency etc.). Simply add following to
your initialization code. Resource is returned, because a fiber is started in the background and has to be terminated
eventually.

```scala mdoc:silent
import com.avast.datadog4s.extension.jvm.*

val jvmMonitoring: Resource[IO, Unit] = factoryResource.flatMap {
  factory =&gt; JvmMonitoring.default[IO](factory)
}

jvmMonitoring.use { _ =&gt; 
    // your application is in here
    IO.unit
}
</code></pre></div></div>

<h4 id="note-on-java-compatibility">Note on Java compatibility:</h4>

<p>Starting with Java 16, applications that use our jvm monitoring need to
add <code class="language-plaintext highlighter-rouge">--add-opens=java.management/sun.management=ALL-UNNAMED</code> as JVM parameter when starting the application. This is
because JVM monitoring uses internal java APIs to obtain certain metrics.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/datadog4s/highlight/highlight.pack.js"></script><script src="/datadog4s/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/datadog4s/js/search.js"></script><script src="/datadog4s/js/main.js"></script></body></html>